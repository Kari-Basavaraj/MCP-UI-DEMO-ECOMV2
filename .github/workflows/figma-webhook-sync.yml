# ============================================================================
# Figma Webhook → Auto-Sync (Production)
# ============================================================================
# Fully automated: Figma save → webhook → GitHub dispatch → this workflow
#   → pull tokens → generate CSS → rebuild widgets → PR → auto-merge
#
# Zero manual steps. Concurrency-safe. Self-healing.
# ============================================================================

name: Figma Webhook Sync

on:
  repository_dispatch:
    types:
      - figma_file_update
      - figma_library_publish

  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual test'
        type: string
      auto_merge:
        description: 'Auto-merge the PR if checks pass'
        required: false
        default: true
        type: boolean

# Prevent concurrent sync runs — latest wins
concurrency:
  group: figma-webhook-sync
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  webhook-sync:
    name: Pull → Generate → Build → PR
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
      FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
      FIGMA_REGION: ${{ secrets.FIGMA_REGION }}

    steps:
      - name: Log trigger context
        run: |
          echo "═══════════════════════════════════════════"
          echo "  Figma Webhook Sync Triggered"
          echo "═══════════════════════════════════════════"
          echo "Event type: ${{ github.event.action }}"
          echo "Triggered by: ${{ github.event.client_payload.triggered_by || inputs.reason || 'webhook' }}"
          echo "File key: ${{ github.event.client_payload.file_key || env.FIGMA_FILE_KEY }}"
          echo "Timestamp: ${{ github.event.client_payload.timestamp || 'N/A' }}"
          echo "Webhook event: ${{ github.event.client_payload.webhook_event || 'N/A' }}"
          echo "═══════════════════════════════════════════"

      - name: Validate file key matches
        run: |
          WEBHOOK_FILE_KEY="${{ github.event.client_payload.file_key }}"
          if [ -n "$WEBHOOK_FILE_KEY" ] && [ "$WEBHOOK_FILE_KEY" != "$FIGMA_FILE_KEY" ]; then
            echo "::warning::Webhook file_key ($WEBHOOK_FILE_KEY) doesn't match configured FIGMA_FILE_KEY ($FIGMA_FILE_KEY). Skipping."
            exit 0
          fi
          echo "File key validated (or no file_key in payload — proceeding)."

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            package-lock.json
            mcp-server/package-lock.json
            web-client/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          npm --prefix mcp-server ci
          npm --prefix web-client ci

      - name: Check Figma secrets
        run: |
          if [ -z "$FIGMA_ACCESS_TOKEN" ]; then
            echo "::error::FIGMA_ACCESS_TOKEN secret is not set."
            exit 1
          fi
          echo "✓ Figma secrets configured"

      # ── Full sync pipeline ──────────────────────────────────────
      - name: Pull variables from Figma
        run: npm run figma:pull:variables

      - name: Normalize variables
        run: npm run figma:normalize:variables

      - name: Generate CSS token files
        run: npm run figma:generate:tokens

      - name: Sync tokens to web-client
        run: npm run tokens:sync

      - name: Rebuild all widgets
        run: npm --prefix mcp-server run build

      - name: Verify pipeline
        run: npm run figma:verify

      # ── Diff summary ───────────────────────────────────────────
      - name: Generate diff summary
        id: diff
        run: |
          git add -A
          CHANGED=$(git diff --cached --name-only | wc -l | tr -d ' ')
          echo "changed_files=$CHANGED" >> "$GITHUB_OUTPUT"

          if [ "$CHANGED" -eq 0 ]; then
            echo "No token changes detected — Figma variables match code."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Token changes detected in $CHANGED files:"
            git diff --cached --stat
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            # Reset staging — let peter-evans handle it
            git reset HEAD
          fi

      # ── Create PR ──────────────────────────────────────────────
      - name: Create PR for token changes
        id: pr
        if: steps.diff.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(figma): auto-sync variables from webhook

            Triggered by: ${{ github.event.action || 'manual' }}
            File key: ${{ github.event.client_payload.file_key || 'N/A' }}
          branch: codex/figma-webhook-sync
          delete-branch: true
          title: 'chore(figma): auto-sync variables from Figma webhook'
          body: |
            ## Figma Webhook Auto-Sync

            A design change was detected in Figma and automatically synced.

            **Trigger:** `${{ github.event.action || inputs.reason || 'manual' }}`
            **Changed files:** ${{ steps.diff.outputs.changed_files }}
            **Request ID:** `${{ github.event.client_payload.request_id || 'N/A' }}`

            ### Pipeline executed:
            1. ✅ Pull variables from Figma API
            2. ✅ Normalize variable payload
            3. ✅ Generate CSS token files
            4. ✅ Sync tokens to web-client
            5. ✅ Rebuild all 12 widgets
            6. ✅ Verify pipeline

            > This PR was created automatically and will auto-merge when CI passes.
          labels: |
            automation
            figma
            webhook

      # ── Auto-merge ─────────────────────────────────────────────
      - name: Enable auto-merge
        if: steps.pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Enabling auto-merge for PR #${{ steps.pr.outputs.pull-request-number }}..."
          gh pr merge "${{ steps.pr.outputs.pull-request-number }}" \
            --auto --squash \
            --subject "chore(figma): auto-sync variables from Figma webhook" || \
          echo "::warning::Auto-merge not available — enable branch protection + require status checks to use auto-merge. PR was created successfully."

      - name: No changes summary
        if: steps.diff.outputs.has_changes == 'false'
        run: echo "✅ Pipeline ran successfully. Figma tokens already match code — no PR needed."

      # ── Artifacts ──────────────────────────────────────────────
      - name: Upload sync artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: figma-webhook-sync-artifacts
          path: |
            tokens/figma/variables.raw.json
            tokens/figma/variables.normalized.json
            docs/code reports/figma-sync-verification.json
            docs/code reports/figma-sync-verification.md
          if-no-files-found: ignore
          retention-days: 14
